<?php

namespace DIISH\SComDisBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * SurveillanceRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class SurveillanceRepository extends EntityRepository
{
    /**
     * Save surveillance
     * 
     * @param Surveillance $surveillance
     * @throws \InvalidArgumentException 
     */
    public function saveSurveillance(Surveillance $surveillance)
    {   
        $this->isExist_EX($surveillance);
        
        if ("6" !== $surveillance->getWeekend()->format('w')) {
            throw new \InvalidArgumentException('Error: Invalid weekend.');
        }

        $manager = $this->getEntityManager();
        $manager->persist($surveillance);
        
        foreach ($surveillance->surveillanceItems as $item ) {
            $item->setSurveillance($surveillance);
            $manager->persist($item);
        }

        $manager->flush();
    }
    
    /**
     * Check whether the surveillance already exists or not.
     * 
     * @param Surveillance $surveillance
     * @return boolean 
     */
    public function isExist(Surveillance $surveillance)
    {
        $other = $this->findOneBy(array(
            'weekOfYear'    => $surveillance->getWeekOfYear(),
            'year'       => $surveillance->getYear(),
            'sentinelSite' => $surveillance->getSentinelSite()->getId(),
            'clinic'        => $surveillance->getClinic()->getId(),
        ));
        
        if ($other) {
            if ($other->getId() === $surveillance->getId())
                return false;
            else
                return true;
        }
        
        return false;
    }
    
    /**
     * Check whether the surveillance already exists or not.
     * 
     * @param Surveillance $surveillance
     * @throws \InvalidArgumentException
     */
    public function isExist_EX(Surveillance $surveillance)
    {
        if ($this->isExist($surveillance)) {
            $message = 'Error: This surveillance is already exist. '.
                            $surveillance->getUniqueTitle();
            throw new \InvalidArgumentException($message);
        }
    }
    
    /**
     * Delete surveillance.
     * 
     * @param Surveillance $surveillance
     * @throws \InvalidArgumentException 
     */
    public function deleteSurveillance($id)
    {
        $surveillance = $this->find($id);
        if (!$surveillance) {
            throw new \InvalidArgumentException('Error: The surveillance is not found.');
        }
        
        $manager = $this->getEntityManager();
        
        foreach ($surveillance->surveillanceItems as $item ) {
            $manager->remove($item);
        }
        
        $manager->remove($surveillance);
        $manager->flush();
    }
    
    /**
     * Receive surveillance.
     * 
     * @param type $id
     * @param type $user
     * @throws \InvalidArgumentException 
     */
    public function receiveSurveillance($id, $displayname)
    {
        $surveillance = $this->find($id);
        if (!$surveillance) {
            throw new \InvalidArgumentException('Error: The surveillance is not found.');
        }
        
        $surveillance->setReceivedBy($displayname);
        $surveillance->setReceivedAt(new \DateTime());
        
        $manager = $this->getEntityManager();
        $manager->persist($surveillance);
        $manager->flush();
    }
    
    /**
     * Find all surveillance by year and sentinel site
     * 
     * @param array $years
     * @param array $sentinelSites
     * @return array
     */
    public function findAllByYearAndSentinelSite(array $years, array $sentinelSites)
    {
        
        $paramYears = $this->getParamYears($years);
        $paramSentinelSites = $this->getParamSentinelSites($sentinelSites);
        
        $manager = $this->getEntityManager();
        $query = $manager->createQuery('SELECT s FROM DIISHSComDisBundle:Surveillance s WHERE ' . 
                $paramYears . ' AND ' . $paramSentinelSites . ' ORDER BY s.year, s.weekOfYear');
        $surveillances = $query->getResult();
        
        return $surveillances;
    }
    
    /**
     * Find all surveillance by year
     * 
     * @param array $years
     * @return array
     */
    public function findAllByYear(array $years)
    {
        
        $paramYears = $this->getParamYears($years);
        
        $manager = $this->getEntityManager();
        $query = $manager->createQuery('SELECT s FROM DIISHSComDisBundle:Surveillance s WHERE ' . 
                $paramYears . ' ORDER BY s.year, s.weekOfYear');
        $surveillances = $query->getResult();
        
        return $surveillances;
    }
    
    /**
     * Find all surveillance by specific week
     * 
     * @param array $years
     * @param int $weekOfYear
     * @return array
     */
    public function findAllBySpecificWeek(array $years, $weekOfYear)
    {
        $paramYears = $this->getParamYears($years);
        
        $manager = $this->getEntityManager();
        $query = $manager->createQuery('SELECT s FROM DIISHSComDisBundle:Surveillance s WHERE ' . 
                $paramYears . ' AND ' . 's.weekOfYear =' . $weekOfYear . ' ORDER BY s.year');
        $surveillances = $query->getResult();
        
        return $surveillances;
    }
    
    protected function getParamYears(array $years)
    {

        $paramYears = '( ';
        for ($i = 0; $i < count($years); $i++) {
            $paramYears = $paramYears . 's.year = ' . $years[$i];
            if ($i === count($years) - 1) {
                $paramYears = $paramYears . ' )';
            } else {
                $paramYears = $paramYears . ' OR ';
            }
        };
        
        return $paramYears;
    }
    
    protected function getParamSentinelSites(array $sentinelSites)
    {

        $paramSentinelSites = '( ';
        for ($i = 0; $i < count($sentinelSites); $i++) {
            $paramSentinelSites = $paramSentinelSites . 's.sentinelSite = ' . $sentinelSites[$i];
            if ($i === count($sentinelSites) - 1) {
                $paramSentinelSites = $paramSentinelSites . ' )';
            } else {
                $paramSentinelSites = $paramSentinelSites . ' OR ';
            }
        };
        
        return $paramSentinelSites;
    }

}